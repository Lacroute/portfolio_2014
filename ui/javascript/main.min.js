$(document).ready(function(){function e(e,t,n){var a=d3.layout.force().charge(-130).linkDistance(60).size([t.w,t.h]),i=e.append("svg").attr("class","pure-hidden-phone");d3.json(n,function(e,t){a.nodes(t.nodes).links(t.links).start();var n=i.selectAll(".link").data(t.links).enter().append("line").attr("class","link"),o=i.selectAll(".node").data(t.nodes).enter().append("circle").attr("class","node").attr("r",function(){return Math.floor(3*Math.random())+1}).call(a.drag);o.append("title").attr("text-anchor","middle").style("font-size","16px").text(function(e){return e.name}),a.on("tick",function(){n.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}),o.attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})})})}$main=$("#main");var t=$main.css("marginTop").replace("px",""),n=4*t;n+=2*$main.css("border-width").replace("px",""),$main.css("min-height",$(window).innerHeight()-n),$(window).resize(function(){$main.css("min-height",$(window).innerHeight()-n),$("#project-container .wrapper").css("max-height",$(window).innerHeight()-162-t)});var a=$("#menu-link"),i=$("#menu");a.on("click",function(){$(this).toggleClass("active"),i.toggleClass("deployed")}),toastFactory=function(e,t){var n=$('<span class="toast">').text(t);e.append(n),n.delay(1200).fadeOut("slow")},$("li[data-project-id] a").on("click",function(e){var t=$(this).parent();return t.hasClass("pure-menu-disabled")?toastFactory(t,"Tu dois d'abord débloquer le projet pour y accéder"):injectTemplateExternal($(e.currentTarget).parent()),!1});var o=$(".card"),r=($(".flip"),$("#project-container")),c=$("#who-i-am"),l=Object.keys(memory).length,s=!0,d=0,p=-1,u={state:"flipped-up",target:"flipped-down"},f={state:"flipped-down",target:"flipped-up"},m="animationend webkitAnimationEnd oanimationend MSAnimationEnd",g="transitionend webkitTransitionEnd otransitionend MSTransitionEnd",h="END_OF_GAME";transitionManager=function(e,t){e.removeClass("anim-"+t.state),e.removeClass(t.state),e.addClass("anim-"+t.target),e.addClass(t.target)},flipManager=function(e,t,n){transitionManager(e,t),memory[n].is_visible=!memory[n].is_visible},flipCard=function(e){if(s){var t=$(e.currentTarget.children[0]),n=o.index(this),a=memory[n].is_visible;if(flow=a?u:f,flipManager(t,flow,n),0===d%2)p=n;else{var i=memory[n],c=memory[p];s=!1,n!==p&&c.project_id===i.project_id&&flow===f?($(".flipped-up").parent().unbind(),$("flipped-up .front, .flipped-up .back").css("cursor","default"),loadProjectAjax(t,function(e){t.one(m,function(){injectTemplate(e,r)})})):t.one(m,function(){flow===f&&(flipManager(i.selector,u,n),flipManager(c.selector,u,p)),s=!0})}return d++,!1}},loadProjectAjax=function(e,t){project_url=e.attr("data-project-url"),$.ajax({type:"GET",url:BASE_URL+project_url,dataType:"json",context:document.body}).done(t)},injectTemplate=function(e,n){$("#instruction").fadeOut(),n.empty(),document.title=e.title,n.append(e.template),$("#project-container .wrapper").css("max-height",$(window).innerHeight()-162-t),$flipped_up=$(".flipped-up"),$flipped_up.each(function(){nth_index=parseInt($(this).attr("id").replace("c",""))+1,$("#back-to-cards li:nth-child("+nth_index+")").addClass("flipped-mirror")}),$to_unlock=$("li[data-project-id="+e.project_id+"]"),$to_unlock.removeClass("pure-menu-disabled"),$padlock=$to_unlock.find("img"),"ui/images/locked.png"==$padlock.attr("src")&&$padlock.attr("src","ui/images/unlocked.png"),$(".pure-menu-selected").removeClass("pure-menu-selected"),$to_unlock.addClass("pure-menu-selected"),$flipped_up.size()==l&&$(document).trigger(h),r.toggleClass("toTop")},backToCards=function(){s=!0,$("#instruction").fadeIn(),r.toggleClass("toTop")},$(document).on("click","#back-to-cards",backToCards),injectTemplateExternal=function(e){r.hasClass("toTop")?(r.removeClass("toTop"),r.one(g,function(){loadProjectAjax(e,function(e){injectTemplate(e,r),r.unbind()})})):loadProjectAjax(e,function(e){injectTemplate(e,r)}),$("div[data-project-id="+e.attr("data-project-id")+"]").not(".flipped-up").each(function(){flipManager($(this),f,$(this).attr("id").replace("c","")),$(".flipped-up").parent().unbind(),$("flipped-up .front, .flipped-up .back").css("cursor","default")})},$(document).on("click",".nav-project-item",function(e){return injectTemplateExternal($(e.currentTarget)),!1}),o.click(flipCard),toggleWhoIAm=function(){$(".cards-wrapper").toggleClass("final"),c.hasClass("displayed")?(c.slideUp(1e3),c.removeClass("displayed"),$("html").unbind("click",closeWhoIAm)):(c.addClass("displayed"),c.slideDown(),$("html").bind("click",closeWhoIAm))},c.click(function(e){e.stopPropagation()}),closeWhoIAm=function(){toggleWhoIAm()},$("#final-step a").on("click",function(){var e=$(this).parent();return e.hasClass("pure-menu-disabled")?toastFactory(e,"Tu dois d'abord débloquer tous les projets pour y accéder"):toggleWhoIAm(),!1}),$(document).bind(h,function(){$(document).unbind("click",backToCards),$("#final-step").removeClass("pure-menu-disabled"),$("#final-step img").attr("src","ui/images/unlocked.png"),$utils=$("#back-to-cards"),$utils.parent().parent().addClass("finish-him"),$utils.on("click",function(){r.removeClass("toTop"),r.one(g,function(){$(".cards-wrapper").css("position","absolute"),toggleWhoIAm()})})});var k=".card",j=$(k),b=d3.selectAll(k),y={};y.w=j.width()+80,y.h=j.height()+80,b.each(function(){e(d3.select(this),y,"json")})});